# Codex 项目开发规范（Pythonic 优先）

> 目标：让 Codex 在本仓库内稳定产出**可读、可测、可维护、最 Pythonic** 的代码。

## 1. 基础原则

- **版本基线**：统一使用 **Python 3.14+**。
- **可读性第一**：优先选择一眼可懂的实现，而不是炫技写法。
- **显式优于隐式**：命名清晰、边界清晰、输入输出清晰。
- **小步迭代**：每次改动尽量聚焦单一目标，保持 PR 小而明确。
- **先设计后编码**：复杂逻辑先写数据结构与流程，再写实现。

## 2. Pythonic 编码约定

### 2.1 命名与结构

- 使用 `snake_case`（变量/函数）、`PascalCase`（类）、`UPPER_SNAKE_CASE`（常量）。
- 函数职责单一；超过 40~60 行时优先拆分。
- 避免“万能工具函数”；按领域拆分模块。

### 2.2 类型标注（必须）

- 所有公共函数与方法必须写类型标注。
- 优先使用现代语法：`list[str]`、`dict[str, Any]`、`str | None`。
- 对跨模块数据使用 `pydantic` 模型或 `dataclass`，避免裸 `dict` 传递。

### 2.3 控制流与数据处理

- 优先早返回（guard clauses），减少多层嵌套。
- 使用推导式时，以可读性为前提；复杂条件改成普通循环。
- 善用标准库（`pathlib`、`collections`、`itertools`、`functools`）。
- 禁止无意义的微优化；先正确，再简洁，再优化。

### 2.4 异常与日志

- 只捕获可预期异常；禁止裸 `except Exception` 吞错。
- 错误信息必须包含上下文（输入参数、关键标识、外部响应码）。
- 使用结构化日志，避免 `print` 调试残留。

## 3. FastAPI 与接口规范

- 每个接口都定义明确的请求/响应模型。
- 使用依赖注入管理配置、客户端和服务对象。
- 所有外部 API 调用设置超时、重试和失败兜底策略。
- 对外返回错误时统一格式，避免泄露内部细节。

## 4. 可测试性要求

- 新增业务逻辑必须包含测试（至少单元测试）。
- 测试命名采用 `test_<行为>_<期望>` 风格。
- 测试用例覆盖：正常路径、边界条件、异常路径。
- 若涉及时间/随机数/外部服务，必须可注入或可 mock。

## 5. 代码质量与工具

- 使用 `ruff` 保持 lint 与格式一致。
- 提交前至少运行：
  - `uv run pytest`
  - `uv run ruff check .`
- 若因环境限制无法执行，需在提交说明中标注原因与风险。

## 6. 变更提交规范

- Commit 标题使用动词开头，清晰说明改动目的。
- PR 标题与正文必须使用中文（含背景、改动说明、测试结果、风险回滚）。
- PR 说明至少包含：
  1. 背景与目标
  2. 主要改动
  3. 测试结果
  4. 风险与回滚点

## 7. Codex 执行清单（每次任务都要做）

1. 阅读相关模块与文档，确认影响范围。
2. 先改类型与数据模型，再改业务流程。
3. 补齐/更新测试。
4. 运行 lint 与测试。
5. 自查是否符合 Pythonic 原则：
   - 命名是否清晰？
   - 函数是否过长？
   - 是否有重复逻辑？
   - 异常是否可定位？

## 8. 明确禁止事项

- 禁止提交不可运行的占位代码（`TODO` 充当实现）。
- 禁止在 import 上套 `try/except`。
- 禁止把业务逻辑堆进路由函数。
- 禁止在未说明原因时引入新依赖。

---

如无特殊说明，本规范默认适用于仓库全局。
