# 手机端上架自动化：缺失构件清单（v0）

> 目标：从“浏览器辅助 MVP”升级到“可稳定控制手机完成上架流程（人工最终确认）”的可执行工程。

## A. 必须先补齐（P0）

- [ ] **统一任务模型（ListingTask / ListingPack）**
  - 现状：`/products/auto-create` 返回草稿 + queued payload，但没有稳定任务 ID、状态机与版本号。
  - 需要：
    - `task_id`、`product_id`、`status`（drafted/running/wait_manual/done/failed）
    - `listing_pack_version`
    - 可重放的输入快照。

- [ ] **任务持久化与审计日志**
  - 现状：任务只在响应里返回，无持久化。
  - 需要：
    - SQLite/Postgres 持久化任务、步骤执行日志、错误快照
    - 审计字段（操作人、时间、设备、结果）。

- [ ] **手机控制适配层（DeviceChannel）**
  - 现状：有 `scripts/android_controller.py` 工具，但未接入 `app/channels`。
  - 需要：
    - 抽象 `DeviceChannel`（adb/scrcpy/坐标/文本输入/截图）
    - 与 `BrowserRPAChannel` 并列挂到 factory。

- [ ] **上架流程步骤编排器（可恢复）**
  - 现状：缺少“步骤级”工作流（如：打开 App → 新建商品 → 填标题 → 填价格...）。
  - 需要：
    - Step DAG/顺序步骤定义
    - 失败可重试 + 从断点恢复。

- [ ] **人工确认闸口（Final Confirm Gate）**
  - 现状：逻辑上有 manual queue，但没有统一确认入口。
  - 需要：
    - “仅填充不点击发布”的硬保护
    - 发布前 checklist（图片、资质、库存、价格）。

## B. 稳定性构件（P1）

- [ ] **设备会话管理**
  - ADB 连接检测、设备心跳、锁屏/解锁状态识别、分辨率自适应。

- [ ] **UI 锚点策略**
  - 坐标点击只是兜底；优先文本/控件锚点，坐标作为 fallback。

- [ ] **异常恢复机制**
  - 弹窗处理、网络慢重试、页面跳转失败回滚。

- [ ] **截图与录屏证据链**
  - 每个关键步骤自动截图，失败附前后文截图路径。

- [ ] **敏感信息治理**
  - 会话、Cookie、账号信息脱敏；产物目录默认加入 `.gitignore`。

## C. 运营与规模化（P2）

- [ ] **批量上架队列**：优先级、并发控制、限流。
- [ ] **选品数据接入**：Excel/ERP/CSV 适配器。
- [ ] **质量门禁**：标题长度、禁词、价格异常、图片缺失自动校验。
- [ ] **可观测性面板**：任务成功率、平均耗时、失败 Top 原因。
- [ ] **回放工具**：按 task_id 回放 payload + 关键截图。

## D. 建议的实施顺序

1. **数据结构先行**：先定 `ListingPack + ListingTask` 与状态机。
2. **持久化与日志**：保证任何失败都可追踪。
3. **接入 DeviceChannel**：把 `android_controller` 变成正式通道。
4. **步骤编排 + 人工确认闸口**：实现“半自动可控发布”。
5. **稳定性与规模化**：补全重试、监控、批量能力。

## E. 本项目当前判定（简述）

- 已具备：AI 草稿生成、浏览器辅助队列、基本 API 骨架。
- 明显缺口：手机通道未产品化、任务不可恢复、审计链不足、缺少最终确认闸口。

