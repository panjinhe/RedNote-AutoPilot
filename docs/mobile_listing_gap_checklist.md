# 手机端全自动上架差距评估与补齐清单（v1）

> 目标：评估当前项目距离“手机端全自动上架（无人值守）”还有多远，并给出可执行补缺方案。  
> 评估口径：以仓库现有实现为准，不假设外部平台 API 可用。

## 一句话结论

- **当前阶段：PoC/MVP+（约 40%~50%）**。  
- **已具备**：草稿生成、任务建模、SQLite 持久化、基础执行器、通道抽象。  
- **核心短板**：手机通道仍是 mock 级实现（未真正驱动 App）、缺少步骤编排与断点恢复、人工确认闸口与安全护栏不足。

## 成熟度雷达（建议）

| 维度 | 当前评分 | 说明 |
|---|---:|---|
| 任务模型与持久化 | 7/10 | `ListingTask`、`ListingPack`、`task_logs` 已有，能查询任务与步骤日志。 |
| 手机自动化能力 | 3/10 | `DeviceAutoChannel` 仍返回模拟成功；未接入 ADB/UIAutomator 实操链路。 |
| 流程可恢复性 | 4/10 | 执行器有失败捕获与日志，但无步骤状态机、无断点恢复。 |
| 安全与人工闸口 | 4/10 | 有 manual/browser_assist 模式，但无强制“最终发布确认”机制。 |
| 可观测性与规模化 | 3/10 | 有基础日志，无指标汇总、队列并发治理与失败画像。 |

## 现状对照（已具备 vs 缺口）

### 已具备（继续沿用）

- [x] `ListingPack` + `ListingTask` 数据结构，且 `ListingTask` 包含 `task_id/status/listing_pack_version/input_snapshot/channel`。  
- [x] SQLite 持久化任务与步骤日志（`listing_tasks`、`task_logs`）。  
- [x] `auto_device | manual | browser_assist` 三模式通道工厂。  
- [x] 自动执行主链路：`create_product -> set_product_online`。  

### 关键缺口（阻塞“手机全自动上架”）

- [ ] **真实设备控制未产品化（P0）**
  - `DeviceAutoChannel` 当前是 `_ok()` 模拟返回；没有 adb 点击、输入、截图、元素定位。
  - `scripts/android_controller.py` 能单点操作，但尚未作为正式通道能力注入工作流。

- [ ] **步骤状态机与断点恢复（P0）**
  - 当前执行器以单函数串行调用为主，失败后只能整单失败，无法“从步骤 N 恢复”。

- [ ] **最终发布闸口（P0）**
  - 缺少统一“填充完成 -> 等待人工确认 -> 才允许发布”的硬约束开关。

- [ ] **UI 锚点与兼容策略（P1）**
  - 需要从纯坐标思路升级为“文本/控件锚点优先 + 坐标兜底 + 分辨率映射”。

- [ ] **证据链与可观测性（P1）**
  - 缺少每步骤截图、失败前后文、运行耗时、失败类型聚合。

- [ ] **批量与调度能力（P2）**
  - 缺少批量任务队列、并发限流、设备占用调度、重试退避策略。

## 建议补缺路线图（按收益/风险排序）

### Phase 1（1~2 周，打通可控半自动）

1. **把 `android_controller` 抽象成 `AndroidDeviceClient`**
   - 在 `app/channels/device_auto.py` 中引入真实客户端（connect/tap/input/screenshot）。
2. **引入步骤定义与状态持久化**
   - 新建 `listing_task_steps` 表：`task_id/step/status/retry_count/artifact_path/error`。
3. **实现 Final Confirm Gate**
   - 增加任务状态：`wait_manual_confirm`；默认只填充不点发布。
4. **失败证据链最小集**
   - 每个关键步骤自动截图并写入 `task_logs.payload`。

### Phase 2（2~4 周，稳定性增强）

1. **UI 自动化可靠性增强**
   - 文本锚点/控件树解析（uiautomator dump）+ 坐标 fallback。
2. **恢复与重试机制**
   - 步骤级重试（指数退避）+ 从最后成功步骤续跑。
3. **设备会话治理**
   - 设备心跳、锁屏解锁、前台应用校验、异常弹窗模板处理。

### Phase 3（4 周+，规模化）

1. **批量上架队列**：优先级、并发、限流、设备池。
2. **质量门禁**：禁词、价格异常、图片完整性、字段缺失校验。
3. **运营面板**：成功率、平均耗时、失败 Top 原因、任务回放。

## 验收标准（判定“接近全自动”）

- 单 SKU 商品在稳定网络下，**10 单连续执行成功率 >= 90%**。
- 任意单失败后，**可在 2 分钟内从断点恢复**。
- 每单都有：输入快照、步骤日志、关键截图、最终状态与人工确认记录。
- 默认策略满足：**不经人工确认，不执行最终发布点击**。

## 当前到目标的大致距离（执行视角）

- 如果以“手机端无人值守直接发布”为目标：**还差约 2~3 个里程碑**。
- 如果以“手机端可控半自动（人工最终确认）”为目标：**完成 Phase 1 后基本可落地试运行**。

